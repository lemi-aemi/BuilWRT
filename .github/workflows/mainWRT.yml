name: Build LemWRT x86_64 Final Ultra-Pro

on:
  workflow_dispatch:
    inputs:
      set_hostname:
        description: 'Masukkan Nama Router (Hostname)'
        required: true
        default: 'LemWRT'
      set_lan_ip:
        description: 'Masukkan IP LAN'
        required: true
        default: '10.10.88.1'
      set_ssid:
        description: 'Masukkan Nama WiFi (SSID)'
        required: true
        default: 'LemWRT_PRO'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/local/lib/node_modules /opt/hostedtoolcache
          sudo docker image prune --all --force
          sudo apt-get clean
          df -h
      - name: Prepare Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libncurses6 libssl-dev python3-distutils rsync unzip zlib1g-dev \
          libncurses-dev zstd swig python3-setuptools python3-distutils rsync unzip zlib1g-dev libncurses-dev zstd

      - name: Clone OpenWrt 25.12 & Custom Branding
        run: |
          git clone https://github.com/openwrt/openwrt.git -b openwrt-25.12 openwrt
          cd openwrt
          
          # CUSTOM BRANDING & LOGIN TEXT
          sed -i 's/OpenWrt/LemWRT/g' include/target.mk
          sed -i 's/OpenWrt/LemWRT/g' package/base-files/files/usr/lib/os-release
          sed -i 's/OpenWrt/LemWRT/g' package/base-files/files/etc/banner
          echo "LemWRT 25.12" > package/base-files/files/etc/openwrt_version

          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add Custom Apps & Themes
        run: |
          cd openwrt/package
          git clone --depth 1 https://github.com/4IceG/luci-app-internet-detector.git
          git clone --depth 1 https://github.com/souwei168/luci-app-store.git
          git clone --depth 1 https://github.com/jerrykuku/luci-theme-argon.git
          git clone --depth 1 https://github.com/jerrykuku/luci-app-argon-config.git
          git clone --depth 1 https://github.com/esirplayground/luci-app-poweroff.git
          git clone --depth 1 https://github.com/4IceG/luci-app-modemband.git
          git clone --depth 1 https://github.com/obsy/apcontroller.git
          git clone --depth 1 https://github.com/4IceG/luci-app-atcommands.git
          git clone --depth 1 https://github.com/4IceG/luci-app-atinout.git
          git clone --depth 1 https://github.com/4IceG/luci-app-mini-diskmanager.git
          git clone --depth 1 https://github.com/4IceG/luci-app-sms-manager.git
          git clone --depth 1 https://github.com/4IceG/luci-app-lite-watchdog.git
          git clone --depth 1 https://github.com/4IceG/luci-app-3ginfo-lite.git
          git clone --depth 1 https://github.com/immortalwrt-collections/openwrt-filebrowser.git
          git clone --depth 1 https://github.com/sirpdboy/luci-app-poweroffdevice.git
          git clone --depth 1 https://github.com/sirpdboy/luci-app-netspeedtest.git
          
          cd ..
          ./scripts/feeds install luci ttyd luci-app-ttyd luci-app-openvpn luci-app-wireguard \
          luci-app-speedtest-cpp uqmi kmod-usb-net-qmi-wwan wget-ssl sms-tool socat \
          kmod-usb-serial-option luci-app-netspeedtest luci-app-poweroffdevice kmod-usb-serial modemmanager luci-app-mwan3 \
          luci-app-statistics usbutils luci-app-adguardhome luci-app-adblock-plus \
          luci-theme-argon luci-app-argon-config luci-app-nlbwmon luci-app-usb-printer parted losetup resize2fs blkid \
          sms-tool kmod-usb-serial-option kmod-usb-serial kmod-usb-net-qmi-wwan kmod-usb-net-cdc-mbim uqmi wget-ssl \
          luci-app-samba4 luci-app-mini-diskmanager luci-app-filebrowser apcontroller luci-app-poweroff luci-app-internet-detector luci-app-store

      - name: Inject Custom DNA (Ultimate Branding & Multi-WAN Layout)
        run: |
          cd openwrt
          mkdir -p files/etc/uci-defaults
          cat <<EOF > files/etc/uci-defaults/99-lemwrt-final
          #!/bin/sh

          # 1. Identitas
          uci set system.@system[0].hostname='${{ github.event.inputs.set_hostname }}'
          echo "mi1003\nmi1003" | passwd root

          # 2. Universal Bridge LAN (Intel x211, USB AX88179, DUB-1312, Realtek)
          uci delete network.lan
          uci set network.lan=interface
          uci set network.lan.device='br-lan'
          uci set network.lan.proto='static'
          uci set network.lan.ipaddr='${{ github.event.inputs.set_lan_ip }}'
          uci set network.lan.netmask='255.255.255.0'
          uci set network.device_lan=device
          uci set network.device_lan.name='br-lan'
          uci set network.device_lan.type='bridge'
          
          # Mapping otomatis semua interface Ethernet/USB ke Bridge LAN kecuali WAN
          # WAN Intel X553 biasanya eth0 atau eth1, kita asumsikan eth0 adalah WAN
          for i in \$(ls /sys/class/net | grep -E 'eth|enp|ena|ethusb'); do
            [ "\$i" != "eth0" ] && uci add_list network.device_lan.ports="\$i"
          done

          # 3. INTERNET SOURCES SETUP
          
          # SOURCE 1: Intel X553 (WAN) - High Priority
          uci set network.wan=interface
          uci set network.wan.device='eth0'
          uci set network.wan.proto='dhcp'
          uci set network.wan.metric='10'

          # SOURCE 2: Modem RM520N (WWAN) - ModemManager
          uci set network.wwan=interface
          uci set network.wwan.proto='modemmanager'
          uci set network.wwan.device='/sys/devices/pci0000:00/0000:00:14.0/usb2/2-1' # Contoh path pcie/usb
          uci set network.wwan.apn='internet'
          uci set network.wwan.auth='none'
          uci set network.wwan.peerdns='1'
          uci set network.wwan.metric='20'

          # SOURCE 3: USB Tethering Android (USBTeth)
          uci set network.USBTeth=interface
          uci set network.USBTeth.proto='dhcp'
          uci set network.USBTeth.device='usb0'
          uci set network.USBTeth.metric='30'

          # 4. MWAN3 FAILOVER CONFIGURATION
          uci delete mwan3.wan
          uci delete mwan3.wan6
          
          # Define Interfaces
          uci set mwan3.wan=interface
          uci set mwan3.wan.enabled='1'
          uci add_list mwan3.wan.track_ip='1.1.1.1'
          uci add_list mwan3.wan.track_ip='8.8.8.8'
          uci set mwan3.wan.family='ipv4'
          uci set mwan3.wan.reliability='2'

          uci set mwan3.wwan=interface
          uci set mwan3.wwan.enabled='1'
          uci add_list mwan3.wwan.track_ip='1.0.0.1'
          uci set mwan3.wwan.family='ipv4'
          uci set mwan3.wwan.reliability='1'

          uci set mwan3.USBTeth=interface
          uci set mwan3.USBTeth.enabled='1'
          uci add_list mwan3.USBTeth.track_ip='9.9.9.9'
          uci set mwan3.USBTeth.family='ipv4'
          uci set mwan3.USBTeth.reliability='1'

          # Define Members
          uci set mwan3.wan_m1_w10=member
          uci set mwan3.wan_m1_w10.interface='wan'
          uci set mwan3.wan_m1_w10.metric='1'
          uci set mwan3.wan_m1_w10.weight='10'

          uci set mwan3.wwan_m2_w10=member
          uci set mwan3.wwan_m2_w10.interface='wwan'
          uci set mwan3.wwan_m2_w10.metric='2'
          uci set mwan3.wwan_m2_w10.weight='10'

          uci set mwan3.usb_m3_w10=member
          uci set mwan3.usb_m3_w10.interface='USBTeth'
          uci set mwan3.usb_m3_w10.metric='3'
          uci set mwan3.usb_m3_w10.weight='10'

          # Define Policy (Failover Order)
          uci set mwan3.failover_policy=policy
          uci add_list mwan3.failover_policy.last_resort='unreachable'
          uci add_list mwan3.failover_policy.use_member='wan_m1_w10'
          uci add_list mwan3.failover_policy.use_member='wwan_m2_w10'
          uci add_list mwan3.failover_policy.use_member='usb_m3_w10'

          # Apply Policy to Default Rule
          uci set mwan3.default_rule=rule
          uci set mwan3.default_rule.dest_ip='0.0.0.0/0'
          uci set mwan3.default_rule.use_policy='failover_policy'

          # 5. WiFi & Firewall
          uci set wireless.radio0.disabled='0'
          uci set wireless.default_radio0.ssid='${{ github.event.inputs.set_ssid }}'
          uci set wireless.default_radio0.key='mi123456'
          uci set wireless.default_radio0.network='lan'
          
          # Add new interfaces to WAN Firewall Zone
          uci add_list firewall.@zone[1].network='wan'
          uci add_list firewall.@zone[1].network='wwan'
          uci add_list firewall.@zone[1].network='USBTeth'

          # 6. Theme & UI Fixes
          uci set argon.@global[0].darkmode='1'
          uci set argon.@global[0].custom_color_primary='#1abc9c'

           # 6. RE-GROUPING MENU
          [ -f /usr/share/luci/menu.d/luci-app-statistics.json ] && sed -i 's/"admin\/statistics"/"admin\/statistics"/g' /usr/share/luci/menu.d/luci-app-statistics.json
          [ -f /usr/share/luci/menu.d/luci-app-nlbwmon.json ] && sed -i 's/"admin\/bandwidth"/"admin\/statistics"/g' /usr/share/luci/menu.d/luci-app-nlbwmon.json

         
          # MODEM Group
          [ -f /usr/share/luci/menu.d/luci-app-mwan3.json ] && sed -i 's/"admin\/network"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-mwan3.json
          [ -f /usr/share/luci/menu.d/ModemManager.json ] && sed -i 's/"admin\/network"/"admin\/modem"/g' /usr/share/luci/menu.d/ModemManager.json
          [ -f /usr/share/luci/menu.d/luci-app-atinout.json ] && sed -i 's/"admin\/services"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-atinout.json
          [ -f /usr/share/luci/menu.d/luci-app-sms-manager.json ] && sed -i 's/"admin\/services"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-sms-manager.json
          [ -f /usr/share/luci/menu.d/luci-app-modemband.json ] && sed -i 's/"admin\/network"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-modemband.json
          [ -f /usr/share/luci/menu.d/luci-app-internet-detector.json ] && sed -i 's/"admin\/services"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-internet-detector.json
  
          # 3. DNS
          [ -f /usr/share/luci/menu.d/luci-app-adguardhome.json ] && sed -i 's/"admin\/services"/"admin\/dns"/g' /usr/share/luci/menu.d/luci-app-adguardhome.json
          [ -f /usr/share/luci/menu.d/luci-app-adblock-plus.json ] && sed -i 's/"admin\/services"/"admin\/dns"/g' /usr/share/luci/menu.d/luci-app-adblock-plus.json
          
          # 4. VPN
          [ -f /usr/share/luci/menu.d/luci-app-openvpn.json ] && sed -i 's/"admin\/services"/"admin\/vpn"/g' /usr/share/luci/menu.d/luci-app-openvpn.json
          [ -f /usr/share/luci/menu.d/luci-app-wireguard.json ] && sed -i 's/"admin\/network"/"admin\/vpn"/g' /usr/share/luci/menu.d/luci-app-wireguard.json
          
          # 5. WIFI
          [ -f /usr/share/luci/menu.d/luci-base.json ] && sed -i 's/"admin\/network\/wireless"/"admin\/wifi"/g' /usr/share/luci/menu.d/luci-base.json
          [ -f /usr/share/luci/menu.d/apcontroller.json ] && sed -i 's/"admin\/network"/"admin\/wifi"/g' /usr/share/luci/menu.d/apcontroller.json

          # 6. NAS (Samba4, FileBrowser & Disk Manager)
          [ -f /usr/share/luci/menu.d/luci-app-samba4.json ] && sed -i 's/"admin\/services"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-samba4.json
          [ -f /usr/share/luci/menu.d/luci-app-filebrowser.json ] && sed -i 's/"admin\/services"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-filebrowser.json
          [ -f /usr/share/luci/menu.d/luci-app-tinyfilemanager.json ] && sed -i 's/"admin\/nas"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-tinyfilemanager.json
          [ -f /usr/share/luci/menu.d/luci-app-mini-diskmanager.json ] && sed -i 's/"admin\/nas"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-mini-diskmanager.json
          
          uci commit
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-lemwrt-final

      - name: Load Configuration
        run: |
          cd openwrt
          cat <<EOF > .config
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_TARGET_x86_64_generic=y
          CONFIG_TARGET_KERNEL_PARTSIZE=512
          CONFIG_TARGET_ROOTFS_PARTSIZE=1024
          CONFIG_TARGET_luci=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-ssl=y
          CONFIG_PACKAGE_luci-app-mwan3=y
          CONFIG_PACKAGE_luci-app-ttyd=y

          # Wireless & Drivers
          CONFIG_PACKAGE_kmod-mt7921e=y
          CONFIG_PACKAGE_mt7921bt-firmware=y
          CONFIG_PACKAGE_wpad-openssl=y
          CONFIG_PACKAGE_kmod-iwlwifi=y
          CONFIG_PACKAGE_iwlwifi-firmware-ax200=y

          # Driver WiFi Qualcomm QCA9882 (ath10k) 
          CONFIG_PACKAGE_kmod-ath10k=y
          CONFIG_PACKAGE_ath10k-firmware-qca988x=y
          CONFIG_PACKAGE_kmod-ath10k-ct=y
          
          # Driver LAN & Bridge (Lengkap sesuai request)
          CONFIG_PACKAGE_kmod-igc=y
          CONFIG_PACKAGE_kmod-ixgbe=y
          CONFIG_PACKAGE_kmod-e1000e=y
          CONFIG_PACKAGE_kmod-r8169=y
          CONFIG_PACKAGE_kmod-r8125=y
          CONFIG_PACKAGE_kmod-usb-net-asix-ax88179=y
          CONFIG_PACKAGE_kmod-usb-net-asix=y
          CONFIG_PACKAGE_kmod-usb-net-rtl8152=y

          # Modem RM520N & Mobile Data
          CONFIG_PACKAGE_modemmanager=y
          CONFIG_PACKAGE_luci-proto-modemmanager=y
          CONFIG_PACKAGE_kmod-usb-net-qmi-wwan=y
          CONFIG_PACKAGE_kmod-usb-net-cdc-mbim=y
          CONFIG_PACKAGE_kmod-mhi-bus=y
          CONFIG_PACKAGE_kmod-mhi-net=y
          CONFIG_PACKAGE_kmod-mhi-pci-generic=y

          # USB Tethering Android
          CONFIG_PACKAGE_kmod-usb-net-rndis=y
          CONFIG_PACKAGE_kmod-usb-net-ipheth=y
          CONFIG_PACKAGE_usbmuxd=y

          # Apps & Themes (dari script sebelumnya)
          CONFIG_PACKAGE_luci-theme-argon=y
          CONFIG_PACKAGE_luci-app-argon-config=y
          CONFIG_PACKAGE_luci-app-adguardhome=y
          CONFIG_PACKAGE_luci-app-filebrowser=y
          CONFIG_PACKAGE_luci-app-mini-diskmanager=y
          CONFIG_PACKAGE_luci-app-3ginfo-lite=y
          CONFIG_PACKAGE_luci-app-modemband=y
          CONFIG_PACKAGE_luci-app-sms-manager=y
          CONFIG_PACKAGE_luci-app-store=y
          CONFIG_PACKAGE_luci-app-poweroff=y
          CONFIG_PACKAGE_luci-app-lite-watchdog=y
          CONFIG_PACKAGE_apcontroller=y
          CONFIG_PACKAGE_luci-app-netspeedtest=y
          CONFIG_PACKAGE_luci-app-adblock-plus=y
          CONFIG_PACKAGE_luci-app-statistics=y
          CONFIG_PACKAGE_luci-app-openvpn=y
          CONFIG_PACKAGE_luci-app-wireguard=y
          CONFIG_PACKAGE_luci-app-autoreboot=y
          CONFIG_PACKAGE_luci-app-internet-detector=y
          CONFIG_PACKAGE_luci-app-speedtest-cpp=y
          CONFIG_PACKAGE_luci-app-samba4=y
          CONFIG_PACKAGE_luci-app-tinyfilemanager=y
          CONFIG_PACKAGE_usbutils=y
          CONFIG_PACKAGE_usbutils=y
          CONFIG_PACKAGE_wget=y
          CONFIG_PACKAGE_curl=y
          CONFIG_PACKAGE_curl-ca-bundle=y
          CONFIG_PACKAGE_kmod-mac80211=y
          CONFIG_PACKAGE_firewall=y
          CONFIG_PACKAGE_iptables=y
          CONFIG_PACKAGE_f2fs-tools=y
          CONFIG_PACKAGE_e2fsprogs=y
          CONFIG_PACKAGE_kmod-fs-f2fs=y
          CONFIG_PACKAGE_kmod-mtd-rw=y
          CONFIG_PACKAGE_kmod-mtd=y
          CONFIG_PACKAGE_mtd=y
          CONFIG_PACKAGE_nmcli=y
          CONFIG_PACKAGE_networkmanager=y
          CONFIG_PACKAGE_network-manager=y
          CONFIG_PACKAGE_network-manager-wwan=y
          CONFIG_PACKAGE_luci-app-nlbwmon=y
          
          EOF
          
          # Merged sisanya dari config user
          make defconfig

      - name: Build Firmware
        run: |
          cd openwrt
          # Mencoba build paralel, jika gagal otomatis ganti ke single-thread dengan log detail (V=s)
          make -j$(nproc) -k || make -j1 V=s -k

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LemWRT-UltraPro-x86_64
          path: openwrt/bin/targets/x86/64/*img.gz
          

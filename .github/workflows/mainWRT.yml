name: Build LemWRT x86_64 Final Ultra-Pro

on:
  workflow_dispatch:
    inputs:
      set_hostname:
        description: 'Masukkan Nama Router (Hostname)'
        required: true
        default: 'LemWRT'
      set_lan_ip:
        description: 'Masukkan IP LAN'
        required: true
        default: '10.10.88.1'
      set_ssid:
        description: 'Masukkan Nama WiFi (SSID)'
        required: true
        default: 'LemWRT_PRO'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/local/lib/node_modules
          sudo docker image prune --all --force
          sudo apt-get clean
          df -h

      - name: Prepare Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev libncurses-dev zstd

      - name: Clone OpenWrt 25.12 & Custom Branding
        run: |
          git clone https://github.com/openwrt/openwrt.git -b openwrt-25.12 openwrt
          cd openwrt
          
          # CUSTOM BRANDING & LOGIN TEXT
          sed -i 's/OpenWrt/LemWRT/g' include/target.mk
          sed -i 's/OpenWrt/LemWRT/g' package/base-files/files/usr/lib/os-release
          sed -i 's/OpenWrt/LemWRT/g' package/base-files/files/etc/banner
          echo "LemWRT 25.12" > package/base-files/files/etc/openwrt_version

          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add Custom Apps & Themes
        run: |
          cd openwrt/package
          # Integrasi Repository Eksternal
          git clone --depth 1 https://github.com/4IceG/luci-app-internet-detector.git
          git clone --depth 1 https://github.com/souwei168/luci-app-store.git
          git clone --depth 1 https://github.com/jerrykuku/luci-theme-argon.git
          git clone --depth 1 https://github.com/jerrykuku/luci-app-argon-config.git
          git clone --depth 1 https://github.com/esirplayground/luci-app-poweroff.git
          git clone --depth 1 https://github.com/4IceG/luci-app-modemband.git
          git clone --depth 1 https://github.com/obsy/apcontroller.git
          git clone --depth 1 https://github.com/4IceG/luci-app-atcommands.git
          git clone --depth 1 https://github.com/4IceG/luci-app-atinout.git
          git clone --depth 1 https://github.com/4IceG/luci-app-mini-diskmanager.git
          git clone --depth 1 https://github.com/4IceG/luci-app-sms-manager.git
          git clone --depth 1 https://github.com/4IceG/luci-app-lite-watchdog.git
          git clone --depth 1 https://github.com/4IceG/luci-app-3ginfo-lite.git
          git clone --depth 1 https://github.com/immortalwrt-collections/openwrt-filebrowser.git
          git clone --depth 1 https://github.com/sirpdboy/luci-app-poweroffdevice.git
          git clone --depth 1 https://github.com/sirpdboy/luci-app-netspeedtest.git
          
          cd ..
          # Install Feeds Tambahan & Dependencies
          ./scripts/feeds install luci ttyd luci-app-ttyd luci-app-openvpn luci-app-wireguard \
          luci-app-speedtest-cpp uqmi kmod-usb-net-qmi-wwan wget-ssl sms-tool socat \
          kmod-usb-serial-option luci-app-netspeedtest luci-app-poweroffdevice kmod-usb-serial modemmanager luci-app-mwan3 \
          luci-app-statistics usbutils luci-app-adguardhome luci-app-adblock-plus \
          luci-theme-argon luci-app-argon-config luci-app-nlbwmon luci-app-usb-printer parted losetup resize2fs blkid \
          sms-tool kmod-usb-serial-option kmod-usb-serial kmod-usb-net-qmi-wwan kmod-usb-net-cdc-mbim uqmi wget-ssl \
          luci-app-samba4 luci-app-mini-diskmanager luci-app-filebrowser apcontroller luci-app-poweroff luci-app-internet-detector luci-app-store

      - name: Inject Custom DNA (Ultimate Branding & Layout)
        run: |
          cd openwrt
          mkdir -p files/etc/uci-defaults
          cat <<EOF > files/etc/uci-defaults/99-lemwrt-final
          #!/bin/sh
          # 1. Identitas
          uci set system.@system[0].hostname='${{ github.event.inputs.set_hostname }}'
          echo "mi1003\nmi1003" | passwd root

          # 2. Universal Bridge LAN
          uci delete network.lan
          uci set network.lan=interface
          uci set network.lan.device='br-lan'
          uci set network.lan.proto='static'
          uci set network.lan.ipaddr='${{ github.event.inputs.set_lan_ip }}'
          uci set network.lan.netmask='255.255.255.0'
          uci set network.device_lan=device
          uci set network.device_lan.name='br-lan'
          uci set network.device_lan.type='bridge'
          for i in \$(ls /sys/class/net | grep -E 'eth|enp|ena'); do
            uci add_list network.device_lan.ports="\$i"
          done

          # 2a. USB Tethering
          uci set network.wan_usb=interface
          uci set network.wan_usb.proto='dhcp'
          uci set network.wan_usb.device='usb0'
          uci set network.wan_usb.metric='20'
          uci set network.device_usb=device
          uci set network.device_usb.name='usb0'
          uci commit network

          # 3. WiFi Setup
          uci set wireless.radio0.disabled='0'
          uci set wireless.radio0.band='5g'
          uci set wireless.radio0.channel='149'
          uci set wireless.radio0.htmode='HE80'
          uci set wireless.radio0.country='US'
          uci set wireless.default_radio0.disabled='0'
          uci set wireless.default_radio0.ssid='${{ github.event.inputs.set_ssid }}'
          uci set wireless.default_radio0.key='mi123456'
          uci set wireless.default_radio0.encryption='sae-mixed'
          uci set wireless.default_radio0.network='lan'


          # 4. Statistik
          uci set luci_statistics.collectd_interface.enable='1'
          uci set luci_statistics.collectd_interface.Interfaces='br-lan usb0'
          uci set luci_statistics.collectd_interface.IgnoreSelected='0'
          uci set nlbwmon.@nlbwmon[0].refresh_interval='2'
          uci set nlbwmon.@nlbwmon[0].top_count='10'
          uci set nlbwmon.@nlbwmon[0].show_interface='1'
          uci set nlbwmon.@nlbwmon[0].show_mac='0'
          uci set nlbwmon.@nlbwmon[0].show_hostname='1'
          uci set nlbwmon.@nlbwmon[0].show_graph='1'
          uci set nlbwmon.@nlbwmon[0].graph_type='0
          uci set nlbwmon.@nlbwmon[0].history_size='1440'
          

          # 5. Theme Argon & Fix-Collision Setup
          uci set argon.@global[0].login_footer='LemWRT: High Performance Network'
          uci set argon.@global[0].bing_background='1'
          uci set argon.@global[0].theme_compatibility_mode='1'
          uci set argon.@global[0].darkmode='1'
          uci set argon.@global[0].rounded_corners='1'
          uci set argon.@global[0].custom_color_enable='1'
          uci set argon.@global[0].custom_color_primary='#1abc9c'
          uci set argon.@global[0].custom_color_accent='#e74c3c'
          uci set argon.@global[0].custom_color_header='#34495e'
          uci set argon.@global[0].custom_color_sidebar='#2c3e50'
          uci set argon.@global[0].custom_color_footer='#34495e'
          uci set argon.@global[0].custom_color_link='#e67e22'
          uci set argon.@global[0].custom_color_button='#e67e22'
          uci set argon.@global[0].custom_color_button_hover='#d35400

          
          # Optimasi ModemManager agar tidak mengunci port AT (Untuk RM520N-GL)
          uci set modemmanager.@modemmanager[0].loglevel='ERR'
          uci set modemmanager.@modemmanager[0].enable_at_locking='0'


          # 6. RE-GROUPING MENU
          [ -f /usr/share/luci/menu.d/luci-app-statistics.json ] && sed -i 's/"admin\/statistics"/"admin\/statistics"/g' /usr/share/luci/menu.d/luci-app-statistics.json
          [ -f /usr/share/luci/menu.d/luci-app-nlbwmon.json ] && sed -i 's/"admin\/bandwidth"/"admin\/statistics"/g' /usr/share/luci/menu.d/luci-app-nlbwmon.json

         
          # MODEM Group
          [ -f /usr/share/luci/menu.d/luci-app-mwan3.json ] && sed -i 's/"admin\/network"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-mwan3.json
          [ -f /usr/share/luci/menu.d/ModemManager.json ] && sed -i 's/"admin\/network"/"admin\/modem"/g' /usr/share/luci/menu.d/ModemManager.json
          [ -f /usr/share/luci/menu.d/luci-app-atcommands.json ] && sed -i 's/"admin\/network"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-atcommands.json
          [ -f /usr/share/luci/menu.d/luci-app-atinout.json ] && sed -i 's/"admin\/services"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-atinout.json
          [ -f /usr/share/luci/menu.d/luci-app-sms-manager.json ] && sed -i 's/"admin\/services"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-sms-manager.json
          [ -f /usr/share/luci/menu.d/luci-app-modemband.json ] && sed -i 's/"admin\/network"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-modemband.json
          [ -f /usr/share/luci/menu.d/luci-app-internet-detector.json ] && sed -i 's/"admin\/services"/"admin\/modem"/g' /usr/share/luci/menu.d/luci-app-internet-detector.json
  
          # 3. DNS
          [ -f /usr/share/luci/menu.d/luci-app-adguardhome.json ] && sed -i 's/"admin\/services"/"admin\/dns"/g' /usr/share/luci/menu.d/luci-app-adguardhome.json
          [ -f /usr/share/luci/menu.d/luci-app-adblock-plus.json ] && sed -i 's/"admin\/services"/"admin\/dns"/g' /usr/share/luci/menu.d/luci-app-adblock-plus.json
          
          # 4. VPN
          [ -f /usr/share/luci/menu.d/luci-app-openvpn.json ] && sed -i 's/"admin\/services"/"admin\/vpn"/g' /usr/share/luci/menu.d/luci-app-openvpn.json
          [ -f /usr/share/luci/menu.d/luci-app-wireguard.json ] && sed -i 's/"admin\/network"/"admin\/vpn"/g' /usr/share/luci/menu.d/luci-app-wireguard.json
          
          # 5. WIFI
          [ -f /usr/share/luci/menu.d/luci-base.json ] && sed -i 's/"admin\/network\/wireless"/"admin\/wifi"/g' /usr/share/luci/menu.d/luci-base.json
          [ -f /usr/share/luci/menu.d/apcontroller.json ] && sed -i 's/"admin\/network"/"admin\/wifi"/g' /usr/share/luci/menu.d/apcontroller.json

          # 6. NAS (Samba4, FileBrowser & Disk Manager)
          [ -f /usr/share/luci/menu.d/luci-app-samba4.json ] && sed -i 's/"admin\/services"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-samba4.json
          [ -f /usr/share/luci/menu.d/luci-app-filebrowser.json ] && sed -i 's/"admin\/services"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-filebrowser.json
          [ -f /usr/share/luci/menu.d/luci-app-tinyfilemanager.json ] && sed -i 's/"admin\/nas"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-tinyfilemanager.json
          [ -f /usr/share/luci/menu.d/luci-app-mini-diskmanager.json ] && sed -i 's/"admin\/nas"/"admin\/nas"/g' /usr/share/luci/menu.d/luci-app-mini-diskmanager.json


          uci commit
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-lemwrt-final

      - name: Load Configuration
        run: |
          cd openwrt
          cat <<EOF > .config
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_TARGET_x86_64_generic=y
          CONFIG_TARGET_KERNEL_PARTSIZE=512
          CONFIG_TARGET_ROOTFS_PARTSIZE=1024
          CONFIG_TARGET_luci=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-ssl=y
          CONFIG_PACKAGE_luci-ssl-openssl=y
          CONFIG_PACKAGE_luci-app-ttyd=y
          CONFIG_PACKAGE_block-mount=y
          CONFIG_PACKAGE_uboot-envtools=y
          CONFIG_PACKAGE_partx-utils=y
          CONFIG_PACKAGE_f2fs-tools=y
          CONFIG_PACKAGE_e2fsprogs=y
          CONFIG_PACKAGE_kmod-fs-f2fs=y
          CONFIG_PACKAGE_kmod-mtd-rw=y
          CONFIG_PACKAGE_kmod-mtd=y
          CONFIG_PACKAGE_mtd=y
          CONFIG_PACKAGE_kmod-crypto-aes=y
          CONFIG_PACKAGE_kmod-crypto-ccm=y
          CONFIG_PACKAGE_kmod-crypto-crc32c=y
          CONFIG_PACKAGE_kmod-crypto-hash=y
          CONFIG_PACKAGE_kmod-crypto-manager=y
          CONFIG_PACKAGE_kmod-crypto-sha256=y
          CONFIG_PACKAGE_kmod-crypto-sha512=y
          CONFIG_PACKAGE_libc=y
          CONFIG_PACKAGE_libgcc=y
          CONFIG_PACKAGE_libpthread=y
          CONFIG_PACKAGE_libustream-openssl=y
          CONFIG_PACKAGE_openssl-util=y
          CONFIG_PACKAGE_openssl=y
          CONFIG_PACKAGE_ca-certificates=y
          CONFIG_PACKAGE_dnsmasq=y
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_firewall=y
          CONFIG_PACKAGE_iptables=y
          CONFIG_PACKAGE_iptables-mod-tproxy=y
          CONFIG_PACKAGE_kmod-ipt-tproxy=y
          CONFIG_PACKAGE_logd=y
          CONFIG_PACKAGE_miniupnpd=y
          CONFIG_PACKAGE_ppp=y
          CONFIG_PACKAGE_ppp-mod-pppoe=y
          CONFIG_PACKAGE_odhcp6c=y
          CONFIG_PACKAGE_odhcpd-ipv6only=y
          CONFIG_PACKAGE_uclient-fetch=y
          CONFIG_PACKAGE_wget=y
          CONFIG_PACKAGE_curl=y
          CONFIG_PACKAGE_curl-ca-bundle=y
          CONFIG_PACKAGE_kmod-slhc=y
          CONFIG_PACKAGE_ppp-mod-pptp=y
          CONFIG_PACKAGE_ppp-mod-chap=y
          CONFIG_PACKAGE_ppp-mod-mschap=y
          CONFIG_PACKAGE_ppp-mod-mschapv2=y
          CONFIG_PACKAGE_kmod-pppoe=y
          CONFIG_PACKAGE_kmod-pptp=y
          CONFIG_PACKAGE_libpam=y
          CONFIG_PACKAGE_libiwinfo-lua=y
          CONFIG_PACKAGE_libiwinfo=y
          CONFIG_PACKAGE_libnl-tiny=y
          CONFIG_PACKAGE_libustream=y
          CONFIG_PACKAGE_libxtables=y
          CONFIG_PACKAGE_mtd-utils=y
          CONFIG_PACKAGE_netifd=y
          CONFIG_PACKAGE_ubusd=y
          CONFIG_PACKAGE_uci=y
          CONFIG_PACKAGE_urandom-seed=y
          CONFIG_PACKAGE_urngd=y
          CONFIG_PACKAGE_zlib=y
          CONFIG_PACKAGE_kmod-ath=y
          CONFIG_PACKAGE_kmod-cfg80211=y
          CONFIG_PACKAGE_kmod-mac80211=y
          CONFIG_PACKAGE_kmod-tun=y
          CONFIG_PACKAGE_lspci=y
          CONFIG_PACKAGE_usbutils=y
          CONFIG_PACKAGE_lsusb=y
          CONFIG_PACKAGE_nmcli=y
          CONFIG_PACKAGE_networkmanager=y
          CONFIG_PACKAGE_kmod-nft-offload=y
          CONFIG_PACKAGE_nftables=y
          CONFIG_PACKAGE_luci-app-nft-qos=y
          CONFIG_PACKAGE_pciutils=y
          CONFIG_PACKAGE_network-manager=y
          CONFIG_PACKAGE_network-manager-wwan=y
          CONFIG_PACKAGE_network-manager-connection-editor=y
          CONFIG_PACKAGE_luci-app-networkmanager=y
          
          # Wireless & Drivers
          CONFIG_PACKAGE_kmod-mt7921e=y
          CONFIG_PACKAGE_mt7921bt-firmware=y
          CONFIG_PACKAGE_wpad-openssl=y
          CONFIG_PACKAGE_kmod-iwlwifi=y
          CONFIG_PACKAGE_iwlwifi-firmware-ax200=y

          # Driver WiFi Qualcomm QCA9882 (ath10k) 
          CONFIG_PACKAGE_kmod-ath10k=y
          CONFIG_PACKAGE_ath10k-firmware-qca988x=y
          CONFIG_PACKAGE_kmod-ath10k-ct=n
          
          # USB Tethering Drivers
          CONFIG_PACKAGE_kmod-usb-net=y
          CONFIG_PACKAGE_kmod-usb-net-rndis=y
          CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y
          CONFIG_PACKAGE_kmod-usb-net-ipheth=y
          CONFIG_PACKAGE_usbmuxd=y
          CONFIG_PACKAGE_libimobiledevice=y

          # Apps & NAS
          CONFIG_PACKAGE_luci-app-samba4=y
          CONFIG_PACKAGE_luci-app-filebrowser=y
          CONFIG_PACKAGE_luci-app-mini-diskmanager=y
          CONFIG_PACKAGE_luci-app-adguardhome=y
          CONFIG_PACKAGE_luci-app-mwan3=y
          CONFIG_PACKAGE_luci-theme-argon=y
          CONFIG_PACKAGE_socat=y
          CONFIG_PACKAGE_luci-app-argon-config=y
          CONFIG_PACKAGE_luci-app-nlbwmon=y
          CONFIG_PACKAGE_luci-app-tinyfilemanager=y
          CONFIG_PACKAGE_luci-app-diskman=y

          # Driver & Apps Lainnya
          CONFIG_PACKAGE_kmod-usb-net-asix-ax88179=y
          CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
          CONFIG_PACKAGE_luci-app-adblock-plus=y
          CONFIG_PACKAGE_luci-app-statistics=y
          CONFIG_PACKAGE_luci-app-openvpn=y
          CONFIG_PACKAGE_luci-app-wireguard=y
          CONFIG_PACKAGE_luci-app-autoreboot=y
          CONFIG_PACKAGE_luci-app-internet-detector=y
          CONFIG_PACKAGE_luci-app-speedtest-cpp=y

          # Custom Apps
          CONFIG_PACKAGE_luci-app-store=y
          CONFIG_PACKAGE_luci-app-poweroff=y
          CONFIG_PACKAGE_luci-app-lite-watchdog=y
          CONFIG_PACKAGE_apcontroller=y
          CONFIG_PACKAGE_luci-app-poweroffdevice=y
          CONFIG_PACKAGE_luci-app-netspeedtest=y

          # Driver LAN PCIe High-End
          CONFIG_PACKAGE_kmod-ixgbe=y
          CONFIG_PACKAGE_kmod-e1000e=y
          CONFIG_PACKAGE_kmod-forcedeth=y
          CONFIG_PACKAGE_kmod-igb=y
          CONFIG_PACKAGE_kmod-igc=y
          CONFIG_PACKAGE_kmod-r8169=y

          # RM520N / 5G Support
          CONFIG_PACKAGE_kmod-mhi-bus=y
          CONFIG_PACKAGE_kmod-mhi-net=y
          CONFIG_PACKAGE_kmod-mhi-pci-generic=y
          CONFIG_PACKAGE_kmod-mhi-wwan-ctrl=y
          CONFIG_PACKAGE_kmod-mhi-wwan-mbim=y
          CONFIG_PACKAGE_kmod-mhi-wwan-qmi=y
          CONFIG_PACKAGE_libmhi=y
          CONFIG_PACKAGE_libqmi=y
          CONFIG_PACKAGE_libmbim=y
          CONFIG_PACKAGE_mbim-utils=y
          CONFIG_PACKAGE_qmi-utils=y
          CONFIG_PACKAGE_luci-app-3ginfo-lite=y
          CONFIG_PACKAGE_luci-app-modemband=y
          CONFIG_PACKAGE_luci-app-atcommands=y
          CONFIG_PACKAGE_luci-app-atinout=y
          CONFIG_PACKAGE_luci-app-sms-manager=y
          CONFIG_PACKAGE_modemmanager=y
          CONFIG_PACKAGE_libmodemmanager=y
          CONFIG_PACKAGE_uqmi=y
          CONFIG_PACKAGE_sms-tool=y
          CONFIG_PACKAGE_wget-ssl=y
          CONFIG_PACKAGE_kmod-usb-serial=y
          CONFIG_PACKAGE_kmod-usb-serial-option=y
          CONFIG_PACKAGE_kmod-usb-net-qmi-wwan=y
          CONFIG_PACKAGE_kmod-usb-net-cdc-mbim=y 
          CONFIG_PACKAGE_minicom=y
          CONFIG_PACKAGE_picocom=y
          CONFIG_PACKAGE_luci-proto-qmi=y
          CONFIG_PACKAGE_luci-proto-mbim=y
          CONFIG_PACKAGE_luci-proto-modemmanager=y
          CONFIG_PACKAGE_usb-modeswitch=y
          CONFIG_PACKAGE_usb-modeswitch-data=y
          CONFIG_PACKAGE_kmod-usb-core=y
          CONFIG_PACKAGE_kmod-usb-uhci=y
          CONFIG_PACKAGE_kmod-usb-net-cdc-ncm=y
          EOF
          
          make defconfig

      - name: Build Firmware
        run: |
          cd openwrt
          # Menggunakan -k agar build x86_64 tetap selesai meskipun ada paket incompatible
          make -j$(nproc) -k || make -j1 V=s -k

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LemWRT-UltraPro-x86_64
          path: openwrt/bin/targets/x86/64/*img.gz
